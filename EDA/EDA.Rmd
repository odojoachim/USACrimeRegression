---
title: "EDA"
author: "Marta Fajlhauer"
date: "3 June 2018"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Exploratory Data Analysis

```{r, echo=FALSE,message=FALSE, results = 'hide', comment = NA}
library(readr)
CrimeData <- read_csv("C:/Users/fajlh/Documents/USB stick/statistics/classification/CrimeDM/CrimeMultivariateClean.csv")
CrimeData$state <- as.factor(CrimeData$state)
CrimeData$communityname <- as.factor(CrimeData$communityname)
```

We already have some understanding about features that may influence rate of violent crimes in a given area. The knowledge is important as we may try to reduce the level of the negatively correlated variables and increase the level of positively correlted to stay safe. To finalise my work on this dataset I will run Explanatory Data Analysis (EDA) on some of the variables


As from information about dataset we know that: *However, the normalization does not preserve relationships between values between attributes*. This leads us to the conclusion that we cannot compare or visualise 2 or more numerical explanatory variables together.  We can still compare the distribution of different attributes across different communities. 

In the summary for variables explained below I have included summary statistics for which:

**MAD  = Mean Absolute Deviation** 

*"In statistics, the median absolute deviation (MAD) is a robust measure of the variability of a univariate sample of quantitative data. For a univariate data set X1, X2, ..., Xn, the MAD is defined as the median of the absolute deviations from the data's median:* $$\textbf{MAD} = median(|X_i - median(X)|)$$
*that is, starting with the residuals (deviations) from the data's median, the MAD is the median of their absolute values."* [7]

* **skew**

*"In probability theory and statistics, skewness is a measure of the asymmetry of the probability distribution of a real-valued random variable about its mean."* [7]

* **kurtosis**

*"Kurtosis is a measure of whether the data are heavy-tailed or light-tailed relative to a normal distribution. That is, data sets with high kurtosis tend to have heavy tails, or outliers. Data sets with low kurtosis tend to have light tails, or lack of outliers."* [8]

* **SE.mean**

*"The standard error (SE) of a parameter is the standard deviation of its sampling distribution[1] or an estimate of the standard deviation[2]. If the parameter or the statistic is the mean, it is called the standard error of the mean (SEM). The sampling distribution of a population mean is generated by repeated sampling and recording of the means obtained. This forms a distribution of different means, and this distribution has its own mean and variance."* [7]

* **CI mean**

* coef.var variation coefficient = It is the ratio of the standard deviation to the mean.

I also did ANOVA table for the variables described. In the ANOVA table, the mean squares for treatments represent the variance in the given variable per states where mean squares for residuals represents the variance within the particular state. F test is the ratio between the groups and within the group. If there is bigger F-statistics value then there is the bigger difference between different groups. 

**Violent Crimes per population among different states**

The graph shows intensity for a rate of violent crimes per given state. When the average rate for a given state is greater than 0.31 then the arrow inside the circle is pointing to red. From the graph, we see that the most dangerous areas of USA are: South Carolina, Louisiana, North Carolina, Florida, Maryland, Delaware, Georgia, Kansas and New Mexico. If the arrow shows orange then there is a medium rate of intensity for violent crimes. It is taking place in 11 different states including Texas. The rest of the states included in our dataset that is marked as green are the safest areas in the USA with the safest places to be are North Dakota and Maine. I have used the maximum average rate that is considered as safe to be 0.21 so any value that is between 0.21 and 0.31 is considered as orange.

**Figure 22: Rates of violent crimes mean in different states**

```{r fig.width=10, fig.height=5,echo=FALSE}
library(png)
library(grid)
img <- readPNG("C:/Users/fajlh/Desktop/Advanced Statistics Project/Gauge.png")
 grid.raster(img)
```

F value from the ANOVA table suggests that there are indeed differences in the number of violent crimes for different states. If the state would have actually an impact on the rate of violent crimes then between the groups would be higher rather than within the group. As F ratio is greater than 1 then this is indeed this situation and we know that state has an impact on the rate of violent crimes rate. Such a small p-value from the test suggests strong evidence that there are differences between the states.

```{r ANOVA, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$ViolentCrimesPerPop)
library(pastecs)
stat.desc(CrimeData$ViolentCrimesPerPop, basic = FALSE)
ANOVA1WAY <- aov(ViolentCrimesPerPop~state, data = CrimeData)
summary(ANOVA1WAY)
```


**population**

We can check not only how violent rate per state looks like but also how it differs across different places within states. Colour of the leaf suggests if there is a big (more than 0.60) rate of violent crime rate represented by the colour red or low (less than 0.20) which is represented by colour green. Places, where the violent crime is between this range, are represented by the orange colour of the leaf. The map shows me that some areas of the USA with less amount of leaf such as North Dakota, South Dakota, Montana and so on are not described in the data set very well.From dataset description we know that: "The per capita violent crimes variable was calculated using population and the sum of crime variables considered violent crimes in the United States: murder, rape, robbery and assault. There was apparently some controversy in some states concerning the counting of rapes. These resulted in missing values for rape, which resulted in incorrect values for per capita violent crime. These cities are not included in the dataset". That's why we have gaps in the map.

**Figure 23: Rates of crimes in a given town, city, community**

```{r fig.width=10, fig.height=5,echo=FALSE}
library(png)
library(grid)
img <- readPNG("C:/Users/fajlh/Desktop/Advanced Statistics Project/map.png")
 grid.raster(img)
```

We can check summary statistics for population variable:

```{r ANOVA1, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$population)
library(pastecs)
stat.desc(CrimeData$population, basic = FALSE)
ANOVA1WAY <- aov(population~state, data = CrimeData)
summary(ANOVA1WAY)
```

Smaller F-statistics value rather than in the previous ANOVA table for the violent crimes per population suggests that the variable states have a smaller impact on the population rate than on violent crimes since every single time I am using states as my levels.  

**householdsize**

The smallest range of household sizes is on Alaska and the biggest range in California. In Florida is the smallest value of 0.1 and New Jersey the highest close to 0.8. State Washington has the biggest number of potential outliers. 

```{r ANOVA2, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$householdsize)
library(pastecs)
stat.desc(CrimeData$householdsize, basic = FALSE)
ANOVA1WAY <- aov(householdsize~state, data = CrimeData)
summary(ANOVA1WAY)
```

**Figure 24**

```{r householdsize boxplot, echo=FALSE, message=FALSE, comment=NA, warning=FALSE ,fig.width=10, fig.height=4}
is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}
library(ggplot2)
library(dplyr)
CrimeData %>%
  group_by(state) %>%
  mutate(outlier = ifelse(is_outlier(householdsize), population, as.numeric(NA))) %>%
  ggplot(., aes(x = state, y = householdsize, fill = state)) +
  geom_boxplot(colour = "black", alpha = 0.7, outlier.shape = 20) +
  scale_y_continuous(name = "Number of Urban areas scaled for each state",
                     breaks = seq(-0.4, 1, 0.1),
                     limits=c(-0.4, 1)) +
  scale_x_discrete(name = "States") +
  ggtitle("Boxplot of household size for different states") +
  theme(legend.position = "none", 
        legend.background = element_rect(fill = "lightgreen", size = 0.5, linetype = "solid"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.text=element_text(size=6)) +
  geom_text(aes(x =state, y = householdsize, 
                label = state, group = state),
            position = position_dodge(width = 1),
            vjust = -0.5, 
            size = 2,
            check_overlap = T)
```

**Figure 25: rate of Violent crimes per given states given proportion of**

**Race Percentage White**

```{r RacePctWhite plots, echo=FALSE, message=FALSE, comment=NA, warning=FALSE ,fig.width=10, fig.height=5}
layout(matrix(c(2, 0, 1, 3), nrow = 2, byrow = TRUE), widths = c(2, 1), heights = c(1, 2), respect = TRUE)
xlim <- with(CrimeData, range(ViolentCrimesPerPop)) * 1.1
plot(racePctWhite  ~ ViolentCrimesPerPop, data = CrimeData, cex.lab = 0.9, 
     xlab = 'states', ylab = 'violenct crimes', type = "n", xlim = xlim)
with(CrimeData, text(ViolentCrimesPerPop, racePctWhite , cex = 0.6, 
                     labels = abbreviate(row.names(CrimeData))))
with(CrimeData, hist(ViolentCrimesPerPop, main = "", xlim = xlim))
with(CrimeData, boxplot(racePctWhite ))
```

We can see how Race Percentage White impacts the result of a rate of violent crimes per population rate. Even if those variables are numerical we are expecting them to represent accurate result for the relationship. The scatter plot suggests that the number of violent crimes in the population decreases with increasing percentage of the white race in the population. The histogram shows a distribution of violent crimes per population which suggests that it is right-skewed distribution, most of the time the rate is small. Boxplot shows the distribution of RacePctWhite that suggests that IQR is from 0.7 to 0.9, the minimum value is 0.3 and there are many outliers. 

```{r ANOVA3, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$racePctWhite)
library(pastecs)
stat.desc(CrimeData$racePctWhite, basic = FALSE)
ANOVA1WAY <- aov(racePctWhite~state, data = CrimeData)
summary(ANOVA1WAY)
```


**numbUrban**

**Figure 26**

```{r numbUrban, echo=FALSE, message=FALSE, comment=NA, warning=FALSE ,fig.width=10, fig.height=5}
CrimeData %>%
  group_by(state) %>%
  ggplot(., mapping = aes(x=state, y=numbUrban, colour = state)) +
  geom_point(size = 0.5, colour = "black") +
  geom_line() +
  xlab("states") + ylab("number of urban regions in a given state") +
  ggtitle("proportion of urban cities and towns in a given state") +
  theme(legend.position = "top", 
        legend.background = element_rect(fill = "lightgreen", size = 1, linetype = "solid"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank(),
        legend.text=element_text(size=6))
```

From this graph, we can see that state Minnesota, North Dakota, Tenessee and Wisconsin are states with the biggest urban areas. States Georgia and Kansas state for which we have the only single record. States Idaho, Vermont, West Virginia and Maine are states with the smallest urban areas.


```{r ANOVA4, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$numbUrban)
library(pastecs)
stat.desc(CrimeData$numbUrban, basic = FALSE)
ANOVA1WAY <- aov(numbUrban~state, data = CrimeData)
summary(ANOVA1WAY)
```


**PctSpeakEnglishOnly**

**Figure 27**

```{r PctSpeakEnglishOnly, echo=FALSE, message=FALSE, comment=NA, warning=FALSE ,fig.width=10, fig.height=5}
par(mfrow=c(1,1))
library(dplyr)
library(ggplot2)
is_outlier <- function(x) {
  return(x < quantile(x, 0.25) - 1.5 * IQR(x) | x > quantile(x, 0.75) + 1.5 * IQR(x))
}
CrimeData %>%
  group_by(state) %>%
  mutate(outlier = ifelse(is_outlier(PctSpeakEnglOnly), PctSpeakEnglOnly, as.numeric(NA))) %>%
  ggplot(., aes(x = state, y = PctSpeakEnglOnly, fill = state)) +
  geom_boxplot(colour = "black", alpha = 0.7, outlier.shape = 20) +
  scale_y_continuous(name = "PctSpeakEnglOnly scaled for each state",
                     breaks = seq(-0.4, 1, 0.1),
                     limits=c(-0.4, 1)) +
  scale_x_discrete(name = "PctSpeakEnglOnly") +
  ggtitle("Boxplot of PctSpeakEnglOnly for different states") +
  theme(legend.position = c(0.1,0.2), 
        legend.background = element_rect(fill = "lightgreen", size = 0.5, linetype = "solid")) +
  geom_text(aes(x =state, y = PctSpeakEnglOnly, 
                label = state, group = state),
            position = position_dodge(width = 1),
            vjust = -0.5, 
            size = 2,
            check_overlap = T)
```

There is a big difference of proportions for people talking English language only between states. California and New Mexico are states where is the lowest percentage of people talking English language only. Alabama, Arkansas, Kentucky, Mississippi, North Carolina, Tennessee are states with the biggest ratio of people talking English language only. The boxplots suggest that there are no apparent outliers between states. 

```{r ANOVA5, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$PctSpeakEnglOnly)
library(pastecs)
stat.desc(CrimeData$PctSpeakEnglOnly, basic = FALSE)
ANOVA1WAY <- aov(PctSpeakEnglOnly~state, data = CrimeData)
summary(ANOVA1WAY)
```

**NumImmig**

**Figure 28**

```{r numImmig, echo=FALSE, message=FALSE, comment=NA, warning=FALSE ,fig.width=8, fig.height=4}
CrimeData %>%
  group_by(state) %>%
  mutate(outlier = ifelse(is_outlier(NumImmig), NumImmig, as.numeric(NA))) %>%
  ggplot(., aes(x = state, y = NumImmig, fill = state)) +
  geom_boxplot(colour = "black", alpha = 0.7, outlier.shape = 20) +
  scale_y_continuous(name = "NumImmig scaled for each state",
                     breaks = seq(-0.4, 1, 0.1),
                     limits=c(-0.4, 1)) +
  scale_x_discrete(name = "NumImmig") +
  ggtitle("Boxplot of NumImmig for different states") +
  theme(legend.position = "none", 
        legend.background = element_rect(fill = "lightgreen", size = 0.5, linetype = "solid"),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank()) +
  geom_text(aes(x =state, y = NumImmig, 
                label = state, group = state),
            position = position_dodge(width = 1),
            vjust = -0.5, 
            size = 2,
            check_overlap = T)
```

Two states: Minnesota and Oklahoma are states with the biggest proportion of immigrants when Utah has the biggest range. 

```{r ANOVA6, echo=FALSE, message=FALSE, comment=NA, warning=FALSE}
library(psych)
describe(CrimeData$NumImmig)
library(pastecs)
stat.desc(CrimeData$NumImmig, basic = FALSE)
ANOVA1WAY <- aov(NumImmig~state, data = CrimeData)
summary(ANOVA1WAY)
```

From the QQplot below we can see that the normality assumption is not an appropriate assumption, hence the ordinary least squares method is not the best approaching to model the data hence the decision of using advanced regression techniques instead. To final modelling process, I have compared Ridge LASSO and elastic net methods.

**Figure 29**

```{r QQplot, echo=FALSE, message=FALSE, comment=NA, warning=FALSE ,fig.width=5, fig.height=2.5}
qqnorm(CrimeData$ViolentCrimesPerPop, main='Violent Crimes')
qqline(CrimeData$ViolentCrimesPerPop)
```
